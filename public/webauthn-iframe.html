<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAuthn Iframe Test</title>
    <meta http-equiv="Permissions-Policy" content="publickey-credentials-create=*, publickey-credentials-get=*">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen p-8">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">WebAuthn Iframe Sandbox Test</h1>
        
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Direct WebAuthn Test (Parent Window)</h2>
            <input type="text" id="username" placeholder="Enter username" 
                   class="w-full p-3 border border-gray-300 rounded-md mb-4">
            <div class="flex gap-4 mb-4">
                <button onclick="testDirectWebAuthn()" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    Test Direct
                </button>
            </div>
            <div id="directStatus" class="hidden"></div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-4">Iframe WebAuthn Test (Sandboxed)</h2>
            <iframe id="webauthnFrame" 
                    src="/webauthn-sandbox.html" 
                    sandbox="allow-scripts allow-same-origin allow-forms allow-top-navigation"
                    allow="publickey-credentials-create *; publickey-credentials-get *"
                    class="w-full h-64 border border-gray-300 rounded-md"></iframe>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Logs</h2>
            <pre id="logs" class="bg-gray-100 p-4 rounded-md text-sm overflow-auto max-h-64 hidden"></pre>
        </div>
    </div>

    <script>
        const logsDiv = document.getElementById('logs');
        const statusDiv = document.getElementById('directStatus');
        
        function log(message) {
            console.log(message);
            logsDiv.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            logsDiv.scrollTop = logsDiv.scrollHeight;
            logsDiv.classList.remove('hidden');
        }
        
        function showStatus(message, type = 'info') {
            statusDiv.className = `mt-4 p-3 rounded-md text-sm ${type === 'error' ? 'bg-red-100 text-red-700' : type === 'success' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`;
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden');
        }

        async function testDirectWebAuthn() {
            log('üîç Testing direct WebAuthn support...');
            
            // Check if WebAuthn is available
            if (!window.PublicKeyCredential) {
                log('‚ùå PublicKeyCredential not available');
                showStatus('WebAuthn not supported', 'error');
                return;
            }
            
            if (!navigator.credentials) {
                log('‚ùå navigator.credentials not available');
                showStatus('Credentials API not available', 'error');
                return;
            }
            
            log('‚úÖ WebAuthn APIs available');
            
            // Check permissions policy
            if (document.featurePolicy) {
                const createAllowed = document.featurePolicy.allowsFeature('publickey-credentials-create');
                const getAllowed = document.featurePolicy.allowsFeature('publickey-credentials-get');
                log('üîê WebAuthn create allowed: ' + createAllowed);
                log('üîê WebAuthn get allowed: ' + getAllowed);
            } else {
                log('‚ö†Ô∏è Feature Policy API not available');
            }
            
            // Try to get a simple credential for testing
            try {
                log('üîë Testing credential creation...');
                
                const options = {
                    challenge: new Uint8Array(32),
                    rp: { name: "Test App" },
                    user: {
                        id: new Uint8Array(16),
                        name: "test@example.com",
                        displayName: "Test User"
                    },
                    pubKeyCredParams: [{ alg: -7, type: "public-key" }],
                    authenticatorSelection: {
                        authenticatorAttachment: "platform",
                        userVerification: "preferred"
                    },
                    timeout: 30000
                };
                
                const credential = await navigator.credentials.create({
                    publicKey: options
                });
                
                if (credential) {
                    log('‚úÖ Direct WebAuthn creation successful!');
                    showStatus('Direct WebAuthn works!', 'success');
                } else {
                    log('‚ùå No credential returned');
                    showStatus('Credential creation failed', 'error');
                }
                
            } catch (error) {
                log('üí• Direct WebAuthn error: ' + error.message);
                showStatus('Direct WebAuthn failed: ' + error.message, 'error');
            }
        }

        // Listen for messages from iframe
        window.addEventListener('message', function(event) {
            if (event.data.type === 'webauthn-log') {
                log('[IFRAME] ' + event.data.message);
            } else if (event.data.type === 'webauthn-status') {
                showStatus('[IFRAME] ' + event.data.message, event.data.status);
            }
        });
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ WebAuthn iframe test initialized');
        });
    </script>
</body>
</html>